# AWS RAG Application Makefile
# æä¾›æ ‡å‡†åŒ–çš„éƒ¨ç½²å’Œç®¡ç†å‘½ä»¤

.PHONY: help install clean deploy destroy test lint check synth diff test-unit test-integration test-e2e test-coverage test-report

# æµ‹è¯•ç¯å¢ƒé…ç½®
test-env:
	@echo "ğŸ” ç¯å¢ƒé…ç½®æµ‹è¯•"
	@echo "==============="
	@echo "AWS_REGION: $(AWS_REGION)"
	@echo "BEDROCK_MODEL_ID: $(BEDROCK_MODEL_ID)"
	@echo "EMBEDDING_MODEL_ID: $(EMBEDDING_MODEL_ID)"
	@echo "ZILLIZ_ENDPOINT: $(ZILLIZ_ENDPOINT)"
	@echo "ZILLIZ_TOKEN: $$(echo $(ZILLIZ_TOKEN) | cut -c1-10)..."
	@echo "==============="
	@echo "âœ… ç¯å¢ƒå˜é‡å·²æ­£ç¡®åŠ è½½ï¼"

# è®¾ç½®é»˜è®¤ç›®æ ‡ä¸ºdeploy
.DEFAULT_GOAL := deploy

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "AWS RAG Application - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@echo "ğŸ“¦ ç¯å¢ƒç®¡ç†:"
	@echo "  make install      - å®‰è£…æ‰€æœ‰ä¾èµ–"
	@echo "  make clean        - æ¸…ç†æ„å»ºäº§ç‰©å’Œç¼“å­˜"
	@echo "  make kill-cdk     - ç»ˆæ­¢æ‰€æœ‰CDKè¿›ç¨‹"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•å‘½ä»¤:"
	@echo "  make test         - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make test-unit    - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  make test-integration - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  make test-e2e     - è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•"
	@echo "  make test-coverage - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  make test-report  - ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"
	@echo "  make test-ui      - è¿è¡ŒUIæµ‹è¯•"
	@echo ""
	@echo "ğŸ” ä»£ç è´¨é‡:"
	@echo "  make lint         - è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  make type-check   - è¿è¡Œç±»å‹æ£€æŸ¥"
	@echo "  make format       - æ ¼å¼åŒ–ä»£ç "
	@echo ""
	@echo "â˜ï¸  éƒ¨ç½²ç®¡ç†:"
	@echo "  make deploy       - éƒ¨ç½²åº”ç”¨åˆ°AWS"
	@echo "  make deploy-web   - éƒ¨ç½²Webæ ˆï¼ˆä¿®å¤CloudFront 403ï¼‰"
	@echo "  make redeploy-web - å®Œå…¨é‡æ–°éƒ¨ç½²Webæ ˆï¼ˆå½»åº•ä¿®å¤403ï¼‰"
	@echo "  make fix-cloudfront - ä¿®å¤CloudFront 403é”™è¯¯"
	@echo "  make verify-web   - éªŒè¯Webéƒ¨ç½²çŠ¶æ€"
	@echo "  make destroy      - é”€æ¯CDKç®¡ç†çš„èµ„æº"
	@echo "  make destroy-all  - å®Œå…¨æ¸…ç†æ‰€æœ‰AWSèµ„æº"
	@echo "  make synth        - åˆæˆCDKæ¨¡æ¿"
	@echo "  make diff         - æŸ¥çœ‹æ ˆå·®å¼‚"
	@echo "  make logs         - æŸ¥çœ‹Lambdaæ—¥å¿—"
	@echo ""
	@echo "ğŸ³ Docker:"
	@echo "  make docker-build - æ„å»ºDockeré•œåƒ"
	@echo "  make docker-run   - è¿è¡ŒDockerå®¹å™¨"
	@echo "  make run-local    - è¿è¡Œæœ¬åœ°APIæœåŠ¡å™¨"
	@echo ""

# ç¯å¢ƒå˜é‡æ£€æŸ¥
check-env:
	@if [ -z "$(ZILLIZ_ENDPOINT)" ]; then \
		echo "âŒ ZILLIZ_ENDPOINTæœªè®¾ç½®"; \
		exit 1; \
	fi
	@if [ -z "$(ZILLIZ_TOKEN)" ]; then \
		echo "âŒ ZILLIZ_TOKENæœªè®¾ç½®"; \
		exit 1; \
	fi

# å®‰è£…ä¾èµ–
install:
	@echo "å®‰è£…Pythonä¾èµ–..."
	pip3 install -r requirements.txt
	pip3 install -r requirements-dev.txt
	@echo "å®‰è£…æµ‹è¯•ä¾èµ–..."
	pip3 install -r tests/requirements-test.txt
	@echo "å®‰è£…CDK..."
	npm install -g aws-cdk@latest
	cd infrastructure && pip3 install -r requirements.txt
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# æ¸…ç†
clean: kill-cdk
	@echo "æ¸…ç†æ„å»ºäº§ç‰©..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf infrastructure/cdk.out
	rm -rf htmlcov coverage.xml .coverage* coverage-*.xml
	rm -rf test-reports/
	rm -f /tmp/rag-deploy.lock
	@echo "âœ… æ¸…ç†å®Œæˆ"

# ç»ˆæ­¢CDKè¿›ç¨‹
kill-cdk:
	@echo "æ£€æŸ¥å¹¶ç»ˆæ­¢CDKè¿›ç¨‹..."
	@ps aux | grep -E "(cdk|aws-cdk)" | grep -v grep | awk '{print $$2}' | xargs -r kill -9 2>/dev/null || true
	@docker ps -a | grep -E "(cdk|sam)" | awk '{print $$1}' | xargs -r docker stop 2>/dev/null || true
	@docker ps -a | grep -E "(cdk|sam)" | awk '{print $$1}' | xargs -r docker rm 2>/dev/null || true
	@echo "âœ… CDKè¿›ç¨‹å·²æ¸…ç†"

# ä»£ç æ£€æŸ¥
lint:
	@echo "è¿è¡Œä»£ç æ ¼å¼åŒ–æ£€æŸ¥..."
	black --check app/ tests/
	isort --check-only app/ tests/
	flake8 app/ tests/
	@echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "æ ¼å¼åŒ–ä»£ç ..."
	black app/ tests/
	isort app/ tests/
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

# ç±»å‹æ£€æŸ¥
type-check:
	@echo "è¿è¡Œç±»å‹æ£€æŸ¥..."
	mypy app/
	@echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡"

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
test:
	@echo "è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	pytest tests/ -v
	@echo "âœ… æµ‹è¯•å®Œæˆ"

# è¿è¡Œå•å…ƒæµ‹è¯•
test-unit:
	@echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
	pytest tests/unit -v -m unit
	@echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"

# è¿è¡Œé›†æˆæµ‹è¯•
test-integration:
	@echo "è¿è¡Œé›†æˆæµ‹è¯•..."
	@chmod +x run_integration_tests.sh
	./run_integration_tests.sh
	@echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"

# è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
test-e2e:
	@echo "è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
	pytest tests/e2e -v -m e2e --tb=short
	@echo "âœ… E2Eæµ‹è¯•å®Œæˆ"

# è¿è¡ŒUIæµ‹è¯•
test-ui:
	@echo "è¿è¡ŒUIæµ‹è¯•..."
	@if [ -f "tests/run_ui_tests.sh" ]; then \
		chmod +x tests/run_ui_tests.sh && ./tests/run_ui_tests.sh; \
	else \
		pytest tests/test_ui*.py -v; \
	fi
	@echo "âœ… UIæµ‹è¯•å®Œæˆ"

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-coverage:
	@echo "ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	pytest tests/ --cov=app --cov-report=html:htmlcov --cov-report=term --cov-report=xml
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ"
	@echo "ğŸ“Š HTMLæŠ¥å‘Š: htmlcov/index.html"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
test-report:
	@echo "ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š..."
	@python generate_test_report.py
	@echo "âœ… æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ"

# å¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰
test-fast:
	@echo "è¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰..."
	pytest tests/ -v -m "not slow"
	@echo "âœ… å¿«é€Ÿæµ‹è¯•å®Œæˆ"

# æµ‹è¯•ç›‘è§†æ¨¡å¼
test-watch:
	@echo "å¯åŠ¨æµ‹è¯•ç›‘è§†æ¨¡å¼..."
	pytest-watch tests/ -- -v

# CDKç›¸å…³å‘½ä»¤
STAGE ?= prod
AWS_REGION ?= us-east-1

# CDK Bootstrapï¼ˆé¦–æ¬¡éƒ¨ç½²å¿…éœ€ï¼‰
bootstrap:
	@echo "ğŸš€ åˆå§‹åŒ–CDK Bootstrap..."
	@echo "  åŒºåŸŸ: $(AWS_REGION)"
	@echo "  è´¦å·: $$(aws sts get-caller-identity --query Account --output text)"
	@echo ""
	@cd infrastructure && \
		CDK_DEFAULT_REGION=$(AWS_REGION) \
		CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
		AWS_DEFAULT_REGION=$(AWS_REGION) \
		npx cdk bootstrap aws://$$CDK_DEFAULT_ACCOUNT/$(AWS_REGION) --context stage=$(STAGE)
	@echo ""
	@echo "âœ… CDK Bootstrap å®Œæˆï¼"
	@echo ""
	@echo "Bootstrap å·²åˆ›å»ºï¼š"
	@echo "  - S3 å­˜å‚¨æ¡¶ï¼šcdk-hnb659fds-assets-*"
	@echo "  - IAM è§’è‰²ï¼šcdk-hnb659fds-*-role"
	@echo "  - SSM å‚æ•°ï¼š/cdk-bootstrap/hnb659fds/version"
	@echo ""
	@echo "ç°åœ¨å¯ä»¥è¿è¡Œ 'make deploy' éƒ¨ç½²åº”ç”¨"

# Bootstrapä¿®å¤ï¼ˆè§£å†³AWSå‡­è¯å’ŒCDK Bootstrapé—®é¢˜ï¼‰
fix-bootstrap:
	@echo "ğŸ”§ ä¿®å¤CDK Bootstrap..."
	@chmod +x fix_cdk_bootstrap.sh
	@./fix_cdk_bootstrap.sh
	@echo "âœ… Bootstrapä¿®å¤å®Œæˆ"

# éƒ¨ç½²å‰æ£€æŸ¥
check: 
	@echo "ğŸ” æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
	@chmod +x pre_deploy_check.sh
	@./pre_deploy_check.sh || (echo "âŒ æ£€æŸ¥å¤±è´¥ï¼Œè¯·å…ˆè§£å†³é—®é¢˜"; exit 1)
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡"

# åˆæˆæ¨¡æ¿
synth: clean
	@echo "åˆæˆCDKæ¨¡æ¿ (stage=$(STAGE))..."
	cd infrastructure && npx cdk synth --context stage=$(STAGE)
	@echo "âœ… æ¨¡æ¿åˆæˆå®Œæˆ"

# æŸ¥çœ‹å·®å¼‚
diff:
	@echo "æŸ¥çœ‹æ ˆå·®å¼‚ (stage=$(STAGE))..."
	cd infrastructure && npx cdk diff --context stage=$(STAGE)

# æ‰“åŒ…Lambdaå‡½æ•°
package-lambda:
	@echo "æ‰“åŒ…Lambdaå‡½æ•°..."
	@if [ -f "package_lambda_optimized.sh" ]; then \
		echo "ä½¿ç”¨ä¼˜åŒ–æ‰“åŒ…è„šæœ¬..."; \
		chmod +x package_lambda_optimized.sh && ./package_lambda_optimized.sh; \
		if [ -f "lambda_deployment_optimized.zip" ]; then \
			mv lambda_deployment_optimized.zip lambda_deployment.zip; \
		fi; \
	else \
		echo "ä½¿ç”¨ä¼ ç»Ÿæ‰“åŒ…æ–¹å¼..."; \
		rm -rf lambda_deployment.zip; \
		cd lambda_functions && \
			pip3 install -r requirements.txt -t . --quiet && \
			zip -r ../lambda_deployment.zip . -x "*.pyc" -x "__pycache__/*" > /dev/null; \
	fi
	@echo "âœ… Lambdaå‡½æ•°æ‰“åŒ…å®Œæˆ (lambda_deployment.zip)"

# éƒ¨ç½²Webæ ˆï¼ˆä¿®å¤CloudFront 403é—®é¢˜ï¼‰
deploy-web: check-env
	@echo "ğŸš€ éƒ¨ç½²Webæ ˆï¼ˆä¿®å¤ç‰ˆï¼‰..."
	@echo "ä½¿ç”¨æ­£ç¡®çš„S3 RESTç«¯ç‚¹å’ŒOAIé…ç½®é¿å…CloudFront 403é”™è¯¯"
	@echo ""
	@echo "1. è·å–AWSè´¦å·ä¿¡æ¯..."
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text) && \
	BUCKET_NAME="rag-web-$$ACCOUNT_ID-$(AWS_REGION)" && \
	echo "  è´¦å·: $$ACCOUNT_ID" && \
	echo "  åŒºåŸŸ: $(AWS_REGION)" && \
	echo "  S3æ¡¶: $$BUCKET_NAME"
	@echo ""
	@echo "2. éƒ¨ç½²Webæ ˆ..."
	@cd infrastructure && \
		set -a && source ../.env && set +a && \
		CDK_DEFAULT_REGION=$${AWS_REGION} \
		CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
		AWS_DEFAULT_REGION=$${AWS_REGION} \
		npx cdk deploy RAG-Web-$(STAGE) \
		--context stage=$(STAGE) \
		--require-approval never \
		--outputs-file web-outputs.json
	@echo ""
	@echo "3. è·å–CloudFrontä¿¡æ¯..."
	@cd infrastructure && \
		if [ -f web-outputs.json ]; then \
			CLOUDFRONT_URL=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontURL', 'N/A'))") && \
			DISTRIBUTION_ID=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontDistributionId', 'N/A'))") && \
			echo "  CloudFront URL: $$CLOUDFRONT_URL" && \
			echo "  Distribution ID: $$DISTRIBUTION_ID"; \
		fi
	@echo ""
	@echo "4. ä¸Šä¼ å‰ç«¯æ–‡ä»¶åˆ°S3..."
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text) && \
	BUCKET_NAME="rag-web-$$ACCOUNT_ID-$(AWS_REGION)" && \
	cd app/views/web && \
	aws s3 sync . s3://$$BUCKET_NAME/ \
		--delete \
		--exclude "*.backup" \
		--exclude ".DS_Store" \
		--exclude "templates/*" && \
	aws s3 cp index.html s3://$$BUCKET_NAME/index.html \
		--content-type "text/html" \
		--cache-control "no-cache, no-store, must-revalidate" && \
	aws s3 cp static/js/ s3://$$BUCKET_NAME/static/js/ \
		--recursive \
		--content-type "application/javascript" && \
	aws s3 cp static/css/ s3://$$BUCKET_NAME/static/css/ \
		--recursive \
		--content-type "text/css"
	@echo ""
	@echo "5. åˆ›å»ºCloudFrontç¼“å­˜å¤±æ•ˆ..."
	@cd infrastructure && \
		if [ -f web-outputs.json ]; then \
			DISTRIBUTION_ID=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontDistributionId', 'N/A'))") && \
			if [ "$$DISTRIBUTION_ID" != "N/A" ]; then \
				aws cloudfront create-invalidation \
					--distribution-id $$DISTRIBUTION_ID \
					--paths "/*" --query 'Invalidation.Id' --output text && \
				echo "  ç¼“å­˜å¤±æ•ˆå·²åˆ›å»º"; \
			fi; \
		fi
	@echo ""
	@echo "âœ… Webæ ˆéƒ¨ç½²å®Œæˆï¼"
	@echo ""
	@echo "ğŸ“‹ åç»­æ­¥éª¤ï¼š"
	@echo "  1. ç­‰å¾…1-2åˆ†é’Ÿè®©CloudFrontç¼“å­˜å¤±æ•ˆç”Ÿæ•ˆ"
	@echo "  2. è®¿é—®CloudFront URLæŸ¥çœ‹å‰ç«¯"
	@echo "  3. å¦‚é‡åˆ°403é”™è¯¯ï¼Œè¿è¡Œ: make fix-cloudfront"
	@echo ""

# å®Œå…¨é‡æ–°éƒ¨ç½²Webæ ˆï¼ˆå½»åº•ä¿®å¤CloudFront 403ï¼‰
redeploy-web: check-env
	@echo "ğŸš¨ å®Œå…¨é‡æ–°éƒ¨ç½²Webæ ˆä»¥ä¿®å¤CloudFront 403æ ¹æœ¬é—®é¢˜"
	@echo "================================"
	@echo ""
	@echo "æ­¤æ“ä½œå°†é”€æ¯å¹¶é‡æ–°åˆ›å»ºCloudFrontåˆ†å‘"
	@echo "  - æ–°çš„CloudFront URLå°†ä¼šæ”¹å˜"
	@echo "  - éƒ¨ç½²éœ€è¦15-20åˆ†é’Ÿ"
	@echo ""
	@read -p "ç¡®è®¤ç»§ç»­ï¼Ÿ(è¾“å…¥ 'yes' ç¡®è®¤): " confirm; \
	if [ "$$confirm" != "yes" ]; then \
		echo "æ“ä½œå·²å–æ¶ˆ"; \
		exit 0; \
	fi
	@echo ""
	@echo "æ­¥éª¤1ï¼šé”€æ¯ç°æœ‰Webæ ˆ..."
	@echo "========================"
	@cd infrastructure && \
		npx cdk destroy RAG-Web-$(STAGE) --force || true
	@echo ""
	@echo "æ­¥éª¤2ï¼šç­‰å¾…èµ„æºæ¸…ç†..."
	@echo "======================"
	@echo "ç­‰å¾…30ç§’ç¡®ä¿èµ„æºå®Œå…¨æ¸…ç†..."
	@sleep 30
	@echo ""
	@echo "æ­¥éª¤3ï¼šé‡æ–°éƒ¨ç½²Webæ ˆ..."
	@echo "======================"
	@# è·å–API URLï¼ˆå¦‚æœå­˜åœ¨ï¼‰
	@API_URL=$$(aws cloudformation describe-stacks \
		--stack-name RAG-API-$(STAGE) \
		--query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
		--output text 2>/dev/null || echo "https://api.example.com") && \
	echo "API URL: $$API_URL" && \
	cd infrastructure && \
		set -a && source ../.env && set +a && \
		CDK_DEFAULT_REGION=$${AWS_REGION} \
		CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
		AWS_DEFAULT_REGION=$${AWS_REGION} \
		API_URL=$$API_URL \
		npx cdk deploy RAG-Web-$(STAGE) \
		--app "./venv/bin/python deploy_web_only.py" \
		--context stage=$(STAGE) \
		--context apiUrl=$$API_URL \
		--require-approval never \
		--outputs-file web-outputs.json
	@echo ""
	@echo "æ­¥éª¤4ï¼šè·å–æ–°çš„CloudFront URL..."
	@echo "================================"
	@cd infrastructure && \
		if [ -f web-outputs.json ]; then \
			NEW_CLOUDFRONT_URL=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontURL', 'N/A'))") && \
			NEW_DISTRIBUTION_ID=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontDistributionId', 'N/A'))") && \
			echo "" && \
			echo "âœ… éƒ¨ç½²æˆåŠŸï¼" && \
			echo "" && \
			echo "ğŸ“‹ æ–°çš„éƒ¨ç½²ä¿¡æ¯ï¼š" && \
			echo "  CloudFront URL: $$NEW_CLOUDFRONT_URL" && \
			echo "  Distribution ID: $$NEW_DISTRIBUTION_ID" && \
			echo "" && \
			echo "è¯·ç­‰å¾…5-10åˆ†é’Ÿè®©CloudFrontå®Œå…¨éƒ¨ç½²" && \
			echo "" && \
			echo "$${NEW_CLOUDFRONT_URL}" > cloudfront_url.txt && \
			echo "æ–°çš„URLå·²ä¿å­˜åˆ° cloudfront_url.txt"; \
		else \
			echo "âŒ æ— æ³•è·å–éƒ¨ç½²ä¿¡æ¯"; \
		fi
	@echo ""
	@echo "æ­¥éª¤5ï¼šä¸Šä¼ å‰ç«¯æ–‡ä»¶..."
	@echo "===================="
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text) && \
	BUCKET_NAME="rag-web-$$ACCOUNT_ID-$(AWS_REGION)" && \
	echo "ä¸Šä¼ æ–‡ä»¶åˆ° S3: $$BUCKET_NAME" && \
	cd app/views/web && \
	aws s3 sync . s3://$$BUCKET_NAME/ \
		--delete \
		--exclude "*.backup" \
		--exclude ".DS_Store" && \
	aws s3 cp index.html s3://$$BUCKET_NAME/index.html \
		--content-type "text/html" \
		--cache-control "no-cache" && \
	aws s3 cp static/css/ s3://$$BUCKET_NAME/static/css/ \
		--recursive \
		--content-type "text/css" && \
	aws s3 cp static/js/ s3://$$BUCKET_NAME/static/js/ \
		--recursive \
		--content-type "application/javascript"
	@echo ""
	@echo "ğŸ‰ å®Œæˆï¼"
	@echo "========"
	@echo ""
	@echo "CloudFrontåˆ†å‘å·²ä½¿ç”¨æ­£ç¡®çš„é…ç½®é‡æ–°åˆ›å»ºï¼š"
	@echo "  âœ… ä½¿ç”¨S3 REST APIç«¯ç‚¹"
	@echo "  âœ… é…ç½®äº†OAI"
	@echo "  âœ… S3æ¡¶ä¿æŒç§æœ‰"
	@echo "  âœ… 403/404é”™è¯¯æ­£ç¡®å¤„ç†"
	@echo ""
	@echo "è¯·è®¿é—®æ–°çš„CloudFront URLæµ‹è¯•ï¼ˆç­‰å¾…5-10åˆ†é’Ÿï¼‰"
	@cd infrastructure && \
		if [ -f web-outputs.json ]; then \
			NEW_CLOUDFRONT_URL=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontURL', 'N/A'))") && \
			echo "URL: $$NEW_CLOUDFRONT_URL"; \
		fi
	@$(MAKE) notify

# ä¿®å¤CloudFront 403é”™è¯¯
fix-cloudfront:
	@echo "ğŸ”§ ä¿®å¤CloudFront 403é”™è¯¯..."
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text) && \
	BUCKET_NAME="rag-web-$$ACCOUNT_ID-$(AWS_REGION)" && \
	echo "S3 Bucket: $$BUCKET_NAME"
	@echo ""
	@echo "1. æ£€æŸ¥OAIé…ç½®..."
	@OAI_ID=$$(aws cloudfront list-cloud-front-origin-access-identities \
		--query "CloudFrontOriginAccessIdentityList.Items[?contains(Comment,'RAG')].Id" \
		--output text | head -1) && \
	if [ -n "$$OAI_ID" ]; then \
		echo "  OAI ID: $$OAI_ID"; \
	else \
		echo "âŒ OAIæœªæ‰¾åˆ°ï¼Œè¯·å…ˆéƒ¨ç½²Webæ ˆ"; \
		exit 1; \
	fi
	@echo ""
	@echo "2. éªŒè¯S3æ–‡ä»¶..."
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text) && \
	BUCKET_NAME="rag-web-$$ACCOUNT_ID-$(AWS_REGION)" && \
	aws s3api head-object --bucket $$BUCKET_NAME --key index.html &>/dev/null && \
		echo "  âœ… index.htmlå­˜åœ¨" || \
		(echo "  âŒ index.htmlä¸å­˜åœ¨ï¼Œæ­£åœ¨ä¸Šä¼ ..." && \
		cd app/views/web && \
		aws s3 cp index.html s3://$$BUCKET_NAME/index.html \
			--content-type "text/html")
	@echo ""
	@echo "3. åˆ›å»ºCloudFrontç¼“å­˜å¤±æ•ˆ..."
	@cd infrastructure && \
		if [ -f web-outputs.json ]; then \
			DISTRIBUTION_ID=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontDistributionId', 'N/A'))") && \
			if [ "$$DISTRIBUTION_ID" != "N/A" ]; then \
				INVALIDATION_ID=$$(aws cloudfront create-invalidation \
					--distribution-id $$DISTRIBUTION_ID \
					--paths "/*" --query 'Invalidation.Id' --output text) && \
				echo "  ç¼“å­˜å¤±æ•ˆID: $$INVALIDATION_ID"; \
			fi; \
		fi
	@echo ""
	@echo "âœ… ä¿®å¤å®Œæˆï¼è¯·ç­‰å¾…1-2åˆ†é’Ÿè®©ç¼“å­˜å¤±æ•ˆç”Ÿæ•ˆ"

# éªŒè¯Webéƒ¨ç½²
verify-web:
	@echo "ğŸ§ª éªŒè¯Webéƒ¨ç½²..."
	@cd infrastructure && \
		if [ -f web-outputs.json ]; then \
			CLOUDFRONT_URL=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontURL', 'N/A'))") && \
			DISTRIBUTION_ID=$$(cat web-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontDistributionId', 'N/A'))") && \
			echo "CloudFront URL: $$CLOUDFRONT_URL" && \
			echo "Distribution ID: $$DISTRIBUTION_ID" && \
			echo "" && \
			echo "æ£€æŸ¥CloudFrontçŠ¶æ€..." && \
			STATUS=$$(aws cloudfront get-distribution --id $$DISTRIBUTION_ID --query 'Distribution.Status' --output text) && \
			echo "çŠ¶æ€: $$STATUS" && \
			echo "" && \
			echo "æµ‹è¯•è®¿é—®..." && \
			HTTP_CODE=$$(curl -s -o /dev/null -w "%{http_code}" $$CLOUDFRONT_URL) && \
			echo "HTTPå“åº”: $$HTTP_CODE" && \
			if [ "$$HTTP_CODE" = "200" ]; then \
				echo "âœ… Webéƒ¨ç½²éªŒè¯æˆåŠŸï¼"; \
			else \
				echo "âŒ Webéƒ¨ç½²éªŒè¯å¤±è´¥ (HTTP $$HTTP_CODE)"; \
				echo "è¯·è¿è¡Œ: make fix-cloudfront"; \
			fi; \
		else \
			echo "âŒ web-outputs.jsonä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ: make deploy-web"; \
		fi

# éƒ¨ç½²å‰ç«¯åˆ°S3ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
deploy-frontend:
	@echo "éƒ¨ç½²å‰ç«¯åˆ°S3..."
	@$(MAKE) deploy-web

# ä».envæ–‡ä»¶è¯»å–å˜é‡
-include .env
export

# éƒ¨ç½²
deploy: check-env clean package-lambda
	@echo "å¼€å§‹éƒ¨ç½² (stage=$(STAGE))..."
	@echo "æ­£åœ¨æ£€æŸ¥å¹¶æ¸…ç†CDKè¿›ç¨‹..."
	@ps aux | grep -E "(cdk|aws-cdk)" | grep -v grep | awk '{print $$2}' | xargs -r kill -9 2>/dev/null || true
	@rm -rf infrastructure/cdk.out
	@echo ""
	@echo "1. ç¯å¢ƒé…ç½®:"
	@echo "  AWS_REGION: $(AWS_REGION) (æ¥è‡ª.env)"
	@echo "  è´¦å·: $$(aws sts get-caller-identity --query Account --output text 2>/dev/null || echo 'éœ€è¦é…ç½®')"
	@echo ""
	@echo "2. æ£€æŸ¥AWSå‡­è¯å’ŒBootstrap..."
	@if ! aws sts get-caller-identity &>/dev/null; then \
		echo "âŒ AWSå‡­è¯æœªé…ç½®ï¼Œè¯·è¿è¡Œ: aws configure"; \
		exit 1; \
	fi
	@echo "  âœ… AWSå‡­è¯æœ‰æ•ˆ"
	@echo ""
	@echo "3. ç¡®ä¿CDK Bootstrap..."
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text) && \
	BOOTSTRAP_BUCKET="cdk-hnb659fds-assets-$$ACCOUNT_ID-$(AWS_REGION)" && \
	if ! aws s3 ls "s3://$$BOOTSTRAP_BUCKET" &>/dev/null; then \
		echo "  âš ï¸ Bootstrapæœªå®Œæˆï¼Œæ­£åœ¨ä¿®å¤..."; \
		chmod +x fix_cdk_bootstrap.sh && ./fix_cdk_bootstrap.sh; \
	else \
		echo "  âœ… Bootstrapå·²å®Œæˆ"; \
	fi
	@echo ""
	@echo "4. å®‰è£…CDKä¾èµ–..."
	@cd infrastructure && pip3 install -r requirements.txt --quiet
	@echo ""
	@echo "5. è®¾ç½®CDKç¯å¢ƒå˜é‡..."
	@export CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) && \
	export CDK_DEFAULT_REGION=$(AWS_REGION) && \
	export AWS_ACCOUNT=$$CDK_DEFAULT_ACCOUNT && \
	export AWS_REGION=$(AWS_REGION) && \
	echo "  CDK_DEFAULT_ACCOUNT=$$CDK_DEFAULT_ACCOUNT" && \
	echo "  CDK_DEFAULT_REGION=$$CDK_DEFAULT_REGION"
	@echo ""
	@echo "6. åˆæˆCloudFormationæ¨¡æ¿..."
	@cd infrastructure && \
		set -a && source ../.env && set +a && \
		export CDK_DEFAULT_REGION=$${AWS_REGION} && \
		export CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) && \
		export AWS_DEFAULT_REGION=$${AWS_REGION} && \
		npx cdk synth --context stage=$(STAGE)
	@echo ""
	@echo "7. æ˜¾ç¤ºè¦éƒ¨ç½²çš„æ ˆ..."
	@cd infrastructure && \
		set -a && source ../.env && set +a && \
		export CDK_DEFAULT_REGION=$${AWS_REGION} && \
		export CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) && \
		export AWS_DEFAULT_REGION=$${AWS_REGION} && \
		npx cdk list --context stage=$(STAGE)
	@echo ""
	@echo "æŒ‰ y ç¡®è®¤éƒ¨ç½²ï¼ŒæŒ‰ n å–æ¶ˆ"
	@read -p "ç¡®è®¤éƒ¨ç½²? (y/n): " confirm; \
	if [ "$$confirm" != "y" ]; then \
		echo "éƒ¨ç½²å·²å–æ¶ˆ"; \
		exit 1; \
	fi
	@echo ""
	@echo "8. å¼€å§‹éƒ¨ç½²æ ˆï¼ˆåŒ…å«ä¿®å¤ç‰ˆWebæ ˆï¼‰..."
	@cd infrastructure && \
		set -a && source ../.env && set +a && \
		export CDK_DEFAULT_REGION=$${AWS_REGION} && \
		export CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) && \
		export AWS_DEFAULT_REGION=$${AWS_REGION} && \
		npx cdk deploy --all \
		--context stage=$(STAGE) \
		--require-approval never \
		--concurrency 1 \
		--parameters RAG-API-$(STAGE):BedrockModelId=$${BEDROCK_MODEL_ID} \
		--parameters RAG-API-$(STAGE):EmbeddingModelId=$${EMBEDDING_MODEL_ID} \
		--parameters RAG-API-$(STAGE):ZillizEndpoint=$${ZILLIZ_ENDPOINT} \
		--parameters RAG-API-$(STAGE):ZillizToken=$${ZILLIZ_TOKEN} \
		--outputs-file cdk-outputs.json
	@echo ""
	@echo "9. åˆ›å»ºCloudFrontç¼“å­˜å¤±æ•ˆ..."
	@cd infrastructure && \
		if [ -f cdk-outputs.json ]; then \
			DISTRIBUTION_ID=$$(cat cdk-outputs.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(data.get('RAG-Web-$(STAGE)', {}).get('CloudFrontDistributionId', 'N/A'))" 2>/dev/null || echo "N/A") && \
			if [ "$$DISTRIBUTION_ID" != "N/A" ]; then \
				aws cloudfront create-invalidation \
					--distribution-id $$DISTRIBUTION_ID \
					--paths "/*" --query 'Invalidation.Id' --output text && \
				echo "  ç¼“å­˜å¤±æ•ˆå·²åˆ›å»º"; \
			fi; \
		fi
	@echo "âœ… éƒ¨ç½²å®Œæˆï¼ˆå·²åŒ…å«CloudFront 403ä¿®å¤ï¼‰"
	@echo ""
	@echo "éƒ¨ç½²ä¿¡æ¯ï¼š"
	@echo "  APIç«¯ç‚¹: è¯·æŸ¥çœ‹CDKè¾“å‡º"
	@if [ -n "$${WEB_BUCKET}" ]; then \
		echo "  å‰ç«¯URL: https://$${WEB_BUCKET}.s3.amazonaws.com/index.html"; \
	fi

# å¿«é€Ÿéƒ¨ç½²ï¼ˆè·³è¿‡ç¡®è®¤ï¼‰
deploy-now: check-env clean package-lambda
	@echo "å¿«é€Ÿéƒ¨ç½²æ¨¡å¼ (stage=$(STAGE))..."
	@echo "ç¯å¢ƒ: AWS_REGION=$(AWS_REGION)"
	@cd infrastructure && \
		bash -c 'source ../.env && \
		export CDK_DEFAULT_REGION=$${AWS_REGION} && \
		export CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) && \
		export AWS_DEFAULT_REGION=$${AWS_REGION} && \
		npx cdk bootstrap aws://$$CDK_DEFAULT_ACCOUNT/$$CDK_DEFAULT_REGION --context stage=$(STAGE) || true'
	@cd infrastructure && \
		bash -c 'source ../.env && \
		export CDK_DEFAULT_REGION=$${AWS_REGION} && \
		export CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) && \
		export AWS_DEFAULT_REGION=$${AWS_REGION} && \
		npx cdk deploy --all \
		--context stage=$(STAGE) \
		--require-approval never \
		--concurrency 1 \
		--parameters RAG-API-$(STAGE):BedrockModelId=$${BEDROCK_MODEL_ID} \
		--parameters RAG-API-$(STAGE):EmbeddingModelId=$${EMBEDDING_MODEL_ID} \
		--parameters RAG-API-$(STAGE):ZillizEndpoint=$${ZILLIZ_ENDPOINT} \
		--parameters RAG-API-$(STAGE):ZillizToken=$${ZILLIZ_TOKEN}'
	@echo "âœ… å¿«é€Ÿéƒ¨ç½²å®Œæˆ"

# é”€æ¯èµ„æºï¼ˆCDKç®¡ç†çš„èµ„æºï¼‰
destroy:
	@echo "âš ï¸  è­¦å‘Š: å³å°†é”€æ¯æ‰€æœ‰AWSèµ„æº (stage=$(STAGE))"
	@read -p "ç¡®è®¤é”€æ¯? (è¾“å…¥'yes'ç¡®è®¤): " confirm && [ "$$confirm" = "yes" ]
	cd infrastructure && npx cdk destroy --all --context stage=$(STAGE) --force
	@echo "âœ… CDKèµ„æºå·²é”€æ¯"
	@echo ""
	@echo "âš ï¸  æ³¨æ„: æŸäº›èµ„æºå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†"
	@echo "  è¿è¡Œ 'make destroy-all' è¿›è¡Œå®Œæ•´æ¸…ç†"

# å®Œå…¨é”€æ¯æ‰€æœ‰èµ„æºï¼ˆåŒ…æ‹¬CDKæœªç®¡ç†çš„ï¼‰
destroy-all:
	@echo "ğŸš¨ è­¦å‘Š: å³å°†å®Œå…¨æ¸…ç†æ‰€æœ‰AWSèµ„æºï¼"
	@echo "è¿™å°†åˆ é™¤ï¼š"
	@echo "  - æ‰€æœ‰CloudFormationæ ˆ"
	@echo "  - æ‰€æœ‰S3å­˜å‚¨æ¡¶åŠå†…å®¹"
	@echo "  - æ‰€æœ‰Lambdaå‡½æ•°"
	@echo "  - æ‰€æœ‰API Gateway"
	@echo "  - ç›¸å…³IAMè§’è‰²å’Œç­–ç•¥"
	@echo ""
	@read -p "ç¡®è®¤å®Œå…¨é”€æ¯? (è¾“å…¥'DELETE ALL'ç¡®è®¤): " confirm && [ "$$confirm" = "DELETE ALL" ]
	@chmod +x cleanup_all_resources.sh
	@./cleanup_all_resources.sh
	@echo "âœ… æ‰€æœ‰èµ„æºå·²å®Œå…¨æ¸…ç†"

# éƒ¨ç½²å•ä¸ªæ ˆ
deploy-stack:
	@echo "éƒ¨ç½²å•ä¸ªæ ˆ (stack=$(STACK), stage=$(STAGE))..."
	cd infrastructure && npx cdk deploy $(STACK)-$(STAGE) \
		--context stage=$(STAGE) \
		--require-approval never
	@echo "âœ… æ ˆéƒ¨ç½²å®Œæˆ"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "æŸ¥çœ‹Lambdaæ—¥å¿— (stage=$(STAGE))..."
	aws logs tail /aws/lambda/RAG-Query-$(STAGE) --follow

# è¿è¡Œæœ¬åœ°API
run-local:
	@echo "å¯åŠ¨æœ¬åœ°APIæœåŠ¡å™¨..."
	cd app && python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000

# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "æ„å»ºDockeré•œåƒ..."
	docker build -t rag-app:latest .
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

# è¿è¡ŒDockerå®¹å™¨
docker-run: docker-build
	@echo "è¿è¡ŒDockerå®¹å™¨..."
	docker run -p 8000:8000 \
		-e AWS_REGION=$${AWS_REGION:-us-east-1} \
		-e ZILLIZ_ENDPOINT=$(ZILLIZ_ENDPOINT) \
		-e ZILLIZ_TOKEN=$(ZILLIZ_TOKEN) \
		--rm rag-app:latest

# å®Œæ•´éƒ¨ç½²ï¼ˆåŒ…å«Webä¿®å¤ï¼‰
deploy-all: check-env clean package-lambda
	@echo "ğŸš€ å®Œæ•´éƒ¨ç½²RAGåº”ç”¨..."
	@echo ""
	@echo "1. éƒ¨ç½²æ•°æ®æ ˆ..."
	@cd infrastructure && \
		set -a && source ../.env && set +a && \
		npx cdk deploy RAG-Data-$(STAGE) \
		--context stage=$(STAGE) \
		--require-approval never
	@echo ""
	@echo "2. éƒ¨ç½²APIæ ˆ..."
	@cd infrastructure && \
		set -a && source ../.env && set +a && \
		npx cdk deploy RAG-API-$(STAGE) \
		--context stage=$(STAGE) \
		--require-approval never \
		--parameters RAG-API-$(STAGE):BedrockModelId=$${BEDROCK_MODEL_ID} \
		--parameters RAG-API-$(STAGE):EmbeddingModelId=$${EMBEDDING_MODEL_ID} \
		--parameters RAG-API-$(STAGE):ZillizEndpoint=$${ZILLIZ_ENDPOINT} \
		--parameters RAG-API-$(STAGE):ZillizToken=$${ZILLIZ_TOKEN}
	@echo ""
	@echo "3. éƒ¨ç½²Webæ ˆï¼ˆä¿®å¤ç‰ˆï¼‰..."
	@$(MAKE) deploy-web STAGE=$(STAGE)
	@echo ""
	@echo "4. éªŒè¯éƒ¨ç½²..."
	@$(MAKE) verify-web
	@echo ""
	@echo "âœ… å®Œæ•´éƒ¨ç½²æˆåŠŸï¼"
	@$(MAKE) notify

# å®Œæ•´çš„CI/CDæµç¨‹
ci: clean install lint type-check test test-coverage
	@echo "âœ… CIæ£€æŸ¥å…¨éƒ¨é€šè¿‡"

# éƒ¨ç½²å‰å‡†å¤‡
prepare: check-env clean synth
	@echo "âœ… éƒ¨ç½²å‡†å¤‡å®Œæˆ"

# æ˜¾ç¤ºå½“å‰é…ç½®
show-config:
	@echo "å½“å‰é…ç½®:"
	@echo "  STAGE: $(STAGE)"
	@echo "  AWS_REGION: $${AWS_REGION:-us-east-1}"
	@echo "  BEDROCK_MODEL_ID: $${BEDROCK_MODEL_ID:-amazon.nova-lite-v1:0}"
	@echo "  EMBEDDING_MODEL_ID: $${EMBEDDING_MODEL_ID:-amazon.titan-embed-text-v2:0}"
	@echo "  ZILLIZ_ENDPOINT: $${ZILLIZ_ENDPOINT:0:20}..."

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup: install
	@echo "è®¾ç½®å¼€å‘ç¯å¢ƒ..."
	@cp .env.example .env 2>/dev/null || true
	@echo "è¯·ç¼–è¾‘ .env æ–‡ä»¶é…ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡"
	@echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

# æ£€æŸ¥é¡¹ç›®å¥åº·çŠ¶æ€
health-check:
	@echo "æ£€æŸ¥é¡¹ç›®å¥åº·çŠ¶æ€..."
	@python -c "import app; print('âœ… Appæ¨¡å—å¯å¯¼å…¥')"
	@python -c "import boto3; print('âœ… AWS SDKå·²å®‰è£…')"
	@python -c "import langchain; print('âœ… LangChainå·²å®‰è£…')"
	@python -c "import pymilvus; print('âœ… Milvuså®¢æˆ·ç«¯å·²å®‰è£…')"
	@echo "âœ… é¡¹ç›®å¥åº·æ£€æŸ¥é€šè¿‡"

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start-all: docker-run
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop-all:
	@echo "åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker stop $$(docker ps -q) 2>/dev/null || true
	@pkill -f "uvicorn" 2>/dev/null || true
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "AWS-Zilliz-RAG é¡¹ç›®ä¿¡æ¯"
	@echo "========================"
	@echo "é¡¹ç›®è·¯å¾„: $$(pwd)"
	@echo "Pythonç‰ˆæœ¬: $$(python3 --version)"
	@echo "Pytestç‰ˆæœ¬: $$(pytest --version | head -1)"
	@echo "AWS CLIç‰ˆæœ¬: $$(aws --version)"
	@echo "CDKç‰ˆæœ¬: $$(cdk --version)"
	@echo ""
	@echo "æµ‹è¯•ç»Ÿè®¡:"
	@echo "  å•å…ƒæµ‹è¯•: $$(find tests/unit -name "test_*.py" | wc -l) ä¸ªæ–‡ä»¶"
	@echo "  é›†æˆæµ‹è¯•: $$(find tests/integration -name "test_*.py" | wc -l) ä¸ªæ–‡ä»¶"
	@echo "  E2Eæµ‹è¯•: $$(find tests/e2e -name "test_*.py" | wc -l) ä¸ªæ–‡ä»¶"
	@echo ""
	@echo "ä»£ç ç»Ÿè®¡:"
	@echo "  Pythonæ–‡ä»¶: $$(find app -name "*.py" | wc -l) ä¸ª"
	@echo "  ä»£ç è¡Œæ•°: $$(find app -name "*.py" -exec wc -l {} + | tail -1 | awk '{print $$1}') è¡Œ"

# å®Œæˆæç¤ºéŸ³
notify:
	@afplay /System/Library/Sounds/Sosumi.aiff

# å¸¦é€šçŸ¥çš„éƒ¨ç½²
deploy-notify: deploy notify
	@echo "âœ… éƒ¨ç½²å®Œæˆå¹¶å·²å‘é€é€šçŸ¥"

# å¸¦é€šçŸ¥çš„æµ‹è¯•
test-notify: test notify
	@echo "âœ… æµ‹è¯•å®Œæˆå¹¶å·²å‘é€é€šçŸ¥"