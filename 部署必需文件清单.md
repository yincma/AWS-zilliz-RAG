# AWS RAG 应用部署必需文件完整清单

## 🎯 核心部署文件（没有这些文件无法部署）

### 1. 主控制文件
```
📁 根目录/
├── 📄 Makefile                              # 部署自动化主脚本（最重要）
├── 📄 .env                                  # 环境变量配置（必须配置）
├── 📄 .env.example                          # 环境变量模板
├── 📄 requirements.txt                      # Python依赖
├── 📄 requirements-dev.txt                  # 开发依赖
├── 📄 requirements-lambda.txt               # Lambda专用依赖
└── 📄 Dockerfile.lambda                     # Lambda容器镜像定义
```

### 2. CDK基础设施文件（创建AWS资源）
```
📁 infrastructure/
├── 📄 app.py                                # CDK主应用入口
├── 📄 app_v2.py                            # CDK V2应用（带CORS修复）
├── 📄 requirements.txt                      # CDK依赖
├── 📄 cdk.json                             # CDK配置
├── 📄 cdk.context.json                     # CDK上下文（可选）
└── 📁 stacks/                              # CDK栈定义
    ├── 📄 __init__.py
    ├── 📄 rag_data_stack.py                # 数据栈（S3、DynamoDB）
    ├── 📄 rag_api_stack.py                 # API栈V1
    ├── 📄 rag_api_stack_v2.py              # API栈V2（推荐）
    └── 📄 rag_web_stack.py                 # Web栈（CloudFront）
```

### 3. Lambda函数代码
```
📁 app/
├── 📄 __init__.py
├── 📁 controllers/
│   ├── 📄 __init__.py
│   └── 📁 lambda_handlers/                 # Lambda处理器
│       ├── 📄 __init__.py
│       ├── 📄 query_handler.py             # 查询处理器（核心）
│       ├── 📄 query_handler_v2.py          # 查询处理器V2
│       ├── 📄 ingest_handler.py            # 文档摄入处理器
│       ├── 📄 cors_helper.py              # CORS辅助函数
│       ├── 📄 health_handler.py           # 健康检查
│       └── 📄 Dockerfile                   # Lambda容器Dockerfile
│
├── 📁 models/                              # 数据模型
│   ├── 📄 __init__.py
│   ├── 📄 document.py                     # 文档模型
│   ├── 📄 embedding.py                    # 嵌入模型
│   ├── 📄 vector_store.py                 # 向量存储
│   ├── 📄 llm.py                         # LLM接口
│   ├── 📄 rag_chain.py                   # RAG链
│   ├── 📄 simple_rag.py                   # 简单RAG实现
│   └── 📄 bedrock_client.py              # Bedrock客户端
│
└── 📁 views/
    └── 📁 web/                            # Web前端
        ├── 📄 index.html                  # 主页面
        ├── 📄 config.json                 # 前端配置（自动生成）
        ├── 📄 styles.css                  # 样式（可选）
        └── 📄 app.js                      # JavaScript（可选）
```

### 4. 构建和部署脚本
```
📁 scripts/
├── 📄 build_lambda_package.sh             # Lambda ZIP包构建脚本
├── 📄 build_lambdas.sh                    # 批量构建Lambda
├── 📄 generate_frontend_config.py         # 生成前端配置
├── 📄 deploy.py                           # Python部署脚本（可选）
├── 📄 test_deployment.py                  # 部署测试脚本
└── 📄 cleanup.sh                          # 清理脚本
```

### 5. Docker相关文件
```
📁 根目录/
├── 📄 Dockerfile.lambda                    # Lambda容器定义
├── 📄 docker-compose.yml                  # Docker组合（可选）
└── 📄 .dockerignore                       # Docker忽略文件
```

### 6. 配置文件
```
📁 config/                                  # 配置目录（可选）
├── 📄 settings.py                         # 应用设置
├── 📄 aws.yaml                           # AWS配置
├── 📄 zilliz.yaml                        # Zilliz配置
└── 📄 database.yaml                      # 数据库配置

📁 根目录/
├── 📄 .env                                # 环境变量（关键）
├── 📄 .env.example                        # 环境变量示例
└── 📄 .gitignore                         # Git忽略配置
```

### 7. 文档文件（指导部署）
```
📁 根目录/
├── 📄 README.md                           # 项目说明
├── 📄 CLAUDE.md                          # Claude指导文件
├── 📄 DEPLOYMENT.md                      # 部署指南（如果有）
└── 📁 docs/
    ├── 📄 architecture.md                # 架构说明
    ├── 📄 api.md                         # API文档
    └── 📄 troubleshooting.md            # 故障排除
```

### 8. 测试文件（验证部署）
```
📁 tests/
├── 📄 __init__.py
├── 📄 test_lambda.py                     # Lambda测试
├── 📄 test_api.py                        # API测试
├── 📄 test_deployment.py                 # 部署测试
└── 📄 test_ui_functionality.py          # UI测试
```

## 📋 部署检查清单

### 必须存在的文件（缺一不可）
- [ ] ✅ Makefile
- [ ] ✅ .env（配置正确）
- [ ] ✅ infrastructure/app_v2.py
- [ ] ✅ infrastructure/stacks/rag_data_stack.py
- [ ] ✅ infrastructure/stacks/rag_api_stack_v2.py
- [ ] ✅ infrastructure/stacks/rag_web_stack.py
- [ ] ✅ app/controllers/lambda_handlers/query_handler.py
- [ ] ✅ app/controllers/lambda_handlers/ingest_handler.py
- [ ] ✅ app/views/web/index.html
- [ ] ✅ scripts/build_lambda_package.sh
- [ ] ✅ scripts/generate_frontend_config.py

### 容器部署必需（推荐方式）
- [ ] ✅ Dockerfile.lambda
- [ ] ✅ requirements-lambda.txt
- [ ] ✅ app/controllers/lambda_handlers/Dockerfile

### ZIP部署必需（备选方式）
- [ ] ✅ scripts/build_lambda_package.sh
- [ ] ✅ requirements.txt

## 🔧 部署前验证命令

```bash
# 1. 检查所有必需文件是否存在
for file in Makefile .env infrastructure/app_v2.py; do
  [ -f "$file" ] && echo "✅ $file" || echo "❌ $file 缺失"
done

# 2. 验证环境变量
grep -E "ZILLIZ_TOKEN|ZILLIZ_ENDPOINT|AWS_REGION" .env

# 3. 检查Python依赖
pip list | grep -E "boto3|pymilvus|aws-cdk-lib"

# 4. 验证Docker（容器部署）
docker --version && echo "✅ Docker已安装"

# 5. 验证AWS CLI
aws sts get-caller-identity && echo "✅ AWS配置正确"
```

## 🚀 一键部署命令序列

```bash
# 完整部署（容器镜像方式 - 推荐）
make deploy

# 或分步部署
make check-env          # 检查环境
make bootstrap          # 初始化CDK（首次）
make build-container    # 构建容器
make push-container     # 推送到ECR
make deploy            # 部署所有栈
make test-lambda       # 测试部署

# ZIP包部署（备选）
make build-lambda-fixed
make deploy-lambda-direct
```

## 📊 文件统计

| 类别 | 文件数量 | 关键程度 |
|------|---------|---------|
| 配置文件 | 8 | ⭐⭐⭐⭐⭐ |
| CDK基础设施 | 9 | ⭐⭐⭐⭐⭐ |
| Lambda代码 | 15 | ⭐⭐⭐⭐⭐ |
| 构建脚本 | 6 | ⭐⭐⭐⭐⭐ |
| 前端文件 | 4 | ⭐⭐⭐⭐ |
| Docker文件 | 3 | ⭐⭐⭐⭐ |
| 测试文件 | 5 | ⭐⭐⭐ |
| 文档 | 5 | ⭐⭐ |
| **总计** | **约55个文件** | - |

## ⚠️ 特别注意

1. **.env文件**：必须正确配置所有环境变量，特别是：
   - ZILLIZ_TOKEN
   - ZILLIZ_ENDPOINT
   - AWS_REGION
   - BEDROCK_MODEL_ID

2. **文件权限**：
   ```bash
   chmod 600 .env                          # 保护敏感信息
   chmod +x scripts/*.sh                   # 脚本可执行
   ```

3. **依赖版本**：确保依赖版本兼容
   - Python 3.9+
   - aws-cdk-lib>=2.100.0
   - boto3>=1.34.0
   - pymilvus>=2.3.0

4. **AWS权限**：需要以下IAM权限：
   - CloudFormation全权限
   - Lambda创建和管理
   - S3桶创建和管理
   - API Gateway管理
   - CloudFront分发
   - ECR仓库管理
   - Bedrock模型访问

## 💡 快速诊断

如果部署失败，按以下顺序检查：

1. **环境变量**：`cat .env | grep -E "ZILLIZ|AWS_REGION|BEDROCK"`
2. **CDK栈**：`cd infrastructure && cdk list`
3. **Lambda包**：`ls -lh *.zip` 或 `docker images | grep rag`
4. **AWS凭证**：`aws sts get-caller-identity`
5. **栈状态**：`aws cloudformation list-stacks --query "StackSummaries[?contains(StackName, 'RAG')]"`

---

**有了这些文件，您就能100%成功部署AWS RAG应用！**

生成时间：2025-08-15