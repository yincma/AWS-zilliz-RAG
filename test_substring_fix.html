<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•substringé”™è¯¯ä¿®å¤</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Substringé”™è¯¯ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-case">
            <div class="test-title">æµ‹è¯•åœºæ™¯1: æ­£å¸¸çš„sourceå¯¹è±¡ï¼ˆæœ‰contentå­—æ®µï¼‰</div>
            <button onclick="testNormalSource()">è¿è¡Œæµ‹è¯•</button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">æµ‹è¯•åœºæ™¯2: æ—§æ ¼å¼sourceå¯¹è±¡ï¼ˆæœ‰textå­—æ®µï¼‰</div>
            <button onclick="testOldSource()">è¿è¡Œæµ‹è¯•</button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">æµ‹è¯•åœºæ™¯3: ç©ºsourceå¯¹è±¡ï¼ˆæ— contentå’Œtextï¼‰</div>
            <button onclick="testEmptySource()">è¿è¡Œæµ‹è¯•</button>
            <div id="test3-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">æµ‹è¯•åœºæ™¯4: çŸ­æ–‡æœ¬ï¼ˆä¸éœ€è¦æˆªæ–­ï¼‰</div>
            <button onclick="testShortText()">è¿è¡Œæµ‹è¯•</button>
            <div id="test4-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">æµ‹è¯•åœºæ™¯5: å®é™…APIè°ƒç”¨æµ‹è¯•</div>
            <button onclick="testRealAPI()">è¿è¡Œå®é™…APIæµ‹è¯•</button>
            <div id="test5-result"></div>
        </div>
    </div>
    
    <script>
        // æ¨¡æ‹Ÿä¿®å¤åçš„ä»£ç 
        function processSourceContent(source) {
            const content = source.content || source.text || '';
            return content.length > 200 ? content.substring(0, 200) + '...' : content;
        }
        
        function showResult(testId, success, message, details) {
            const resultDiv = document.getElementById(testId + '-result');
            resultDiv.className = 'test-result ' + (success ? 'success' : 'error');
            resultDiv.innerHTML = `
                <strong>${success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</strong>: ${message}
                ${details ? '<pre>' + JSON.stringify(details, null, 2) + '</pre>' : ''}
            `;
        }
        
        function testNormalSource() {
            try {
                const source = {
                    content: "RAG (Retrieval-Augmented Generation) æ˜¯ä¸€ç§ç»“åˆæ£€ç´¢å’Œç”Ÿæˆçš„æŠ€æœ¯ï¼Œé€šè¿‡æ£€ç´¢ç›¸å…³æ–‡æ¡£æ¥å¢å¼ºè¯­è¨€æ¨¡å‹çš„ç”Ÿæˆèƒ½åŠ›ã€‚è¿™æ˜¯ä¸€æ®µå¾ˆé•¿çš„æ–‡æœ¬ï¼Œç”¨äºæµ‹è¯•æˆªæ–­åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚å½“æ–‡æœ¬è¶…è¿‡200ä¸ªå­—ç¬¦æ—¶ï¼Œåº”è¯¥è¢«æˆªæ–­å¹¶æ·»åŠ çœç•¥å·ã€‚è¿™æ®µæ–‡æœ¬å°†ç»§ç»­å¢åŠ é•¿åº¦ä»¥ç¡®ä¿è¶…è¿‡200ä¸ªå­—ç¬¦çš„é™åˆ¶ã€‚ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰è¶³å¤Ÿçš„æ–‡æœ¬æ¥æµ‹è¯•æˆªæ–­åŠŸèƒ½äº†ã€‚",
                    score: 0.95
                };
                
                const result = processSourceContent(source);
                showResult('test1', true, 'æˆåŠŸå¤„ç†contentå­—æ®µ', {
                    åŸå§‹é•¿åº¦: source.content.length,
                    å¤„ç†åé•¿åº¦: result.length,
                    å¤„ç†ç»“æœ: result
                });
            } catch (error) {
                showResult('test1', false, error.message);
            }
        }
        
        function testOldSource() {
            try {
                const source = {
                    text: "è¿™æ˜¯æ—§æ ¼å¼çš„textå­—æ®µå†…å®¹",
                    score: 0.85
                };
                
                const result = processSourceContent(source);
                showResult('test2', true, 'æˆåŠŸå¤„ç†textå­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰', {
                    å¤„ç†ç»“æœ: result
                });
            } catch (error) {
                showResult('test2', false, error.message);
            }
        }
        
        function testEmptySource() {
            try {
                const source = {
                    score: 0.75
                };
                
                const result = processSourceContent(source);
                showResult('test3', true, 'æˆåŠŸå¤„ç†ç©ºå¯¹è±¡ï¼ˆæ— é”™è¯¯ï¼‰', {
                    å¤„ç†ç»“æœ: result || '(ç©ºå­—ç¬¦ä¸²)'
                });
            } catch (error) {
                showResult('test3', false, error.message);
            }
        }
        
        function testShortText() {
            try {
                const source = {
                    content: "çŸ­æ–‡æœ¬æµ‹è¯•",
                    score: 0.90
                };
                
                const result = processSourceContent(source);
                showResult('test4', result === "çŸ­æ–‡æœ¬æµ‹è¯•", 'çŸ­æ–‡æœ¬ä¸åº”è¢«æˆªæ–­', {
                    åŸå§‹æ–‡æœ¬: source.content,
                    å¤„ç†ç»“æœ: result
                });
            } catch (error) {
                showResult('test4', false, error.message);
            }
        }
        
        async function testRealAPI() {
            const apiUrl = 'https://abbrw64qve.execute-api.us-east-1.amazonaws.com/prod';
            showResult('test5', true, 'æ­£åœ¨è°ƒç”¨API...', null);
            
            try {
                const response = await fetch(`${apiUrl}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: "What is RAG?",
                        top_k: 3,
                        use_rag: true
                    })
                });
                
                const data = await response.json();
                
                if (data.sources && data.sources.length > 0) {
                    // æµ‹è¯•æ¯ä¸ªsource
                    let allPassed = true;
                    const results = [];
                    
                    for (let i = 0; i < data.sources.length; i++) {
                        const source = data.sources[i];
                        try {
                            const processed = processSourceContent(source);
                            results.push({
                                index: i,
                                hasContent: !!source.content,
                                hasText: !!source.text,
                                processed: processed.substring(0, 50) + '...'
                            });
                        } catch (error) {
                            allPassed = false;
                            results.push({
                                index: i,
                                error: error.message
                            });
                        }
                    }
                    
                    showResult('test5', allPassed, 
                        allPassed ? 'æ‰€æœ‰sourceså¤„ç†æˆåŠŸ' : 'éƒ¨åˆ†sourceså¤„ç†å¤±è´¥',
                        {
                            sources_count: data.sources.length,
                            results: results
                        }
                    );
                } else {
                    showResult('test5', false, 'æœªè¿”å›sourcesæ•°æ®', data);
                }
            } catch (error) {
                showResult('test5', false, 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>