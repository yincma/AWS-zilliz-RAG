<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试substring错误修复</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .test-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a67d8;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Substring错误修复测试</h1>
        
        <div class="test-case">
            <div class="test-title">测试场景1: 正常的source对象（有content字段）</div>
            <button onclick="testNormalSource()">运行测试</button>
            <div id="test1-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">测试场景2: 旧格式source对象（有text字段）</div>
            <button onclick="testOldSource()">运行测试</button>
            <div id="test2-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">测试场景3: 空source对象（无content和text）</div>
            <button onclick="testEmptySource()">运行测试</button>
            <div id="test3-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">测试场景4: 短文本（不需要截断）</div>
            <button onclick="testShortText()">运行测试</button>
            <div id="test4-result"></div>
        </div>
        
        <div class="test-case">
            <div class="test-title">测试场景5: 实际API调用测试</div>
            <button onclick="testRealAPI()">运行实际API测试</button>
            <div id="test5-result"></div>
        </div>
    </div>
    
    <script>
        // 模拟修复后的代码
        function processSourceContent(source) {
            const content = source.content || source.text || '';
            return content.length > 200 ? content.substring(0, 200) + '...' : content;
        }
        
        function showResult(testId, success, message, details) {
            const resultDiv = document.getElementById(testId + '-result');
            resultDiv.className = 'test-result ' + (success ? 'success' : 'error');
            resultDiv.innerHTML = `
                <strong>${success ? '✅ 通过' : '❌ 失败'}</strong>: ${message}
                ${details ? '<pre>' + JSON.stringify(details, null, 2) + '</pre>' : ''}
            `;
        }
        
        function testNormalSource() {
            try {
                const source = {
                    content: "RAG (Retrieval-Augmented Generation) 是一种结合检索和生成的技术，通过检索相关文档来增强语言模型的生成能力。这是一段很长的文本，用于测试截断功能是否正常工作。当文本超过200个字符时，应该被截断并添加省略号。这段文本将继续增加长度以确保超过200个字符的限制。现在我们已经有足够的文本来测试截断功能了。",
                    score: 0.95
                };
                
                const result = processSourceContent(source);
                showResult('test1', true, '成功处理content字段', {
                    原始长度: source.content.length,
                    处理后长度: result.length,
                    处理结果: result
                });
            } catch (error) {
                showResult('test1', false, error.message);
            }
        }
        
        function testOldSource() {
            try {
                const source = {
                    text: "这是旧格式的text字段内容",
                    score: 0.85
                };
                
                const result = processSourceContent(source);
                showResult('test2', true, '成功处理text字段（向后兼容）', {
                    处理结果: result
                });
            } catch (error) {
                showResult('test2', false, error.message);
            }
        }
        
        function testEmptySource() {
            try {
                const source = {
                    score: 0.75
                };
                
                const result = processSourceContent(source);
                showResult('test3', true, '成功处理空对象（无错误）', {
                    处理结果: result || '(空字符串)'
                });
            } catch (error) {
                showResult('test3', false, error.message);
            }
        }
        
        function testShortText() {
            try {
                const source = {
                    content: "短文本测试",
                    score: 0.90
                };
                
                const result = processSourceContent(source);
                showResult('test4', result === "短文本测试", '短文本不应被截断', {
                    原始文本: source.content,
                    处理结果: result
                });
            } catch (error) {
                showResult('test4', false, error.message);
            }
        }
        
        async function testRealAPI() {
            const apiUrl = 'https://abbrw64qve.execute-api.us-east-1.amazonaws.com/prod';
            showResult('test5', true, '正在调用API...', null);
            
            try {
                const response = await fetch(`${apiUrl}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: "What is RAG?",
                        top_k: 3,
                        use_rag: true
                    })
                });
                
                const data = await response.json();
                
                if (data.sources && data.sources.length > 0) {
                    // 测试每个source
                    let allPassed = true;
                    const results = [];
                    
                    for (let i = 0; i < data.sources.length; i++) {
                        const source = data.sources[i];
                        try {
                            const processed = processSourceContent(source);
                            results.push({
                                index: i,
                                hasContent: !!source.content,
                                hasText: !!source.text,
                                processed: processed.substring(0, 50) + '...'
                            });
                        } catch (error) {
                            allPassed = false;
                            results.push({
                                index: i,
                                error: error.message
                            });
                        }
                    }
                    
                    showResult('test5', allPassed, 
                        allPassed ? '所有sources处理成功' : '部分sources处理失败',
                        {
                            sources_count: data.sources.length,
                            results: results
                        }
                    );
                } else {
                    showResult('test5', false, '未返回sources数据', data);
                }
            } catch (error) {
                showResult('test5', false, '网络请求失败: ' + error.message);
            }
        }
    </script>
</body>
</html>