# ğŸ¯ Destroy å‘½ä»¤æ”¹è¿›æ–¹æ¡ˆ - é›¶æŠ€æœ¯å€ºåŠ¡ç‰ˆæœ¬

## ğŸ“Š é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜
1. **ç›´æ¥æ“ä½œèµ„æº**ï¼šMakefile ç›´æ¥åˆ é™¤ S3/ECR ç­‰èµ„æºï¼Œç»•è¿‡ CloudFormation
2. **çŠ¶æ€ä¸ä¸€è‡´**ï¼šCloudFormation è®¤ä¸ºèµ„æºå­˜åœ¨ï¼Œä½†å®é™…å·²è¢«åˆ é™¤
3. **BucketDeployment å¤±è´¥**ï¼šè‡ªå®šä¹‰èµ„æºæ‰¾ä¸åˆ°å·²åˆ é™¤çš„ S3 æ¡¶
4. **å¤æ‚åº¦é«˜**ï¼š900+ è¡Œçš„ destroy é€»è¾‘ï¼Œéš¾ä»¥ç»´æŠ¤

### æŠ€æœ¯å€ºåŠ¡æ ¹æº
```bash
# é—®é¢˜ä»£ç ç¤ºä¾‹ï¼ˆåŸ Makefile ç¬¬ 841-849 è¡Œï¼‰
for bucket in $(aws s3api list-buckets ...); do
    aws s3 rm s3://$$bucket --recursive  # âŒ ç›´æ¥åˆ é™¤ï¼Œç»•è¿‡ CloudFormation
    aws s3api delete-bucket --bucket $$bucket  # âŒ ç ´åçŠ¶æ€ä¸€è‡´æ€§
done
```

## âœ¨ è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒç†å¿µ
**è®© CloudFormation åšå®ƒæ“…é•¿çš„äº‹ï¼Œæˆ‘ä»¬åªåœ¨å¿…è¦æ—¶ååŠ©**

### æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | åŸæ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ |
|------|--------|--------|
| **ä»£ç è¡Œæ•°** | 900+ è¡Œ | 50 è¡Œ |
| **ç›´æ¥æ“ä½œèµ„æº** | âœ… æ˜¯ | âŒ å¦ |
| **çŠ¶æ€ä¸€è‡´æ€§** | âŒ ç»å¸¸ä¸ä¸€è‡´ | âœ… å§‹ç»ˆä¸€è‡´ |
| **æŠ€æœ¯å€ºåŠ¡** | é«˜ | é›¶ |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | æä½ |
| **å¯é æ€§** | ä¸­ç­‰ | é«˜ |
| **ç¬¦åˆæœ€ä½³å®è·µ** | âŒ | âœ… |

## ğŸš€ å®æ–½æ–¹æ¡ˆ

### é€‰é¡¹ 1ï¼šæç®€æ–¹æ¡ˆï¼ˆæ¨èç»™å¤§å¤šæ•°ç”¨æˆ·ï¼‰

```makefile
# åªéœ€è¦è¿™ä¸€ä¸ªå‘½ä»¤
destroy:
	cd infrastructure && cdk destroy --all --force
```

**ä¼˜ç‚¹**ï¼š
- ä»£ç æœ€å°‘ï¼ˆ1è¡Œï¼‰
- é›¶æŠ€æœ¯å€ºåŠ¡
- CDK è‡ªåŠ¨å¤„ç†æ‰€æœ‰ç»†èŠ‚

**é€‚ç”¨åœºæ™¯**ï¼š
- æ­£å¸¸çš„å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
- èµ„æºçŠ¶æ€æ­£å¸¸çš„æƒ…å†µ

### é€‰é¡¹ 2ï¼šæ™ºèƒ½æ–¹æ¡ˆï¼ˆæ¨èç»™éœ€è¦æ›´å¤šæ§åˆ¶çš„ç”¨æˆ·ï¼‰

ä½¿ç”¨æä¾›çš„ Python è„šæœ¬ `scripts/destroy_stacks.py`ï¼š

```bash
# æ™ºèƒ½é”€æ¯
make destroy-new

# æ£€æŸ¥çŠ¶æ€
make check-stacks-new

# å¼ºåˆ¶é”€æ¯
make destroy-force-new
```

**ä¼˜ç‚¹**ï¼š
- è‡ªåŠ¨å¤„ç†å¤±è´¥çš„æ ˆ
- æ™ºèƒ½åˆ†æä¾èµ–å…³ç³»
- æä¾›è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯
- ä»ç„¶æ˜¯é›¶æŠ€æœ¯å€ºåŠ¡

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”Ÿäº§ç¯å¢ƒ
- éœ€è¦å¤„ç†å¤æ‚å¤±è´¥æƒ…å†µ
- éœ€è¦å®¡è®¡å’Œæ—¥å¿—

## ğŸ“ è¿ç§»æ­¥éª¤

### 1. å¤‡ä»½å½“å‰ Makefile
```bash
cp Makefile Makefile.backup
```

### 2. æ·»åŠ æ–°çš„ destroy å‘½ä»¤
```bash
# æ–¹æ³• Aï¼šä½¿ç”¨æä¾›çš„ patch æ–‡ä»¶
cat Makefile.patch >> Makefile

# æ–¹æ³• Bï¼šæ‰‹åŠ¨æ›¿æ¢ destroy å‘½ä»¤
# ç¼–è¾‘ Makefileï¼Œæ›¿æ¢ç¬¬ 832-1078 è¡Œ
```

### 3. æ·»åŠ  Python è„šæœ¬ï¼ˆå¦‚æœé€‰æ‹©æ™ºèƒ½æ–¹æ¡ˆï¼‰
```bash
# è„šæœ¬å·²åˆ›å»ºåœ¨ scripts/destroy_stacks.py
chmod +x scripts/destroy_stacks.py
```

### 4. æµ‹è¯•æ–°å‘½ä»¤
```bash
# å…ˆæ£€æŸ¥çŠ¶æ€
make check-stacks-new

# ç„¶åæ‰§è¡Œé”€æ¯
make destroy-new
```

## ğŸ¯ æœ€ä½³å®è·µ

### DO âœ…
1. **å§‹ç»ˆä½¿ç”¨ CDK/CloudFormation å‘½ä»¤**
2. **åœ¨ CDK æ ˆä¸­æ­£ç¡®è®¾ç½® RemovalPolicy**
3. **è®© CloudFormation ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸ**
4. **åªåœ¨ DELETE_FAILED æ—¶æ‰ä»‹å…¥**

### DON'T âŒ
1. **ä¸è¦ç›´æ¥åˆ é™¤ AWS èµ„æº**
2. **ä¸è¦ç»•è¿‡ CloudFormation**
3. **ä¸è¦è¯•å›¾"ä¼˜åŒ–" CDK çš„è¡Œä¸º**
4. **ä¸è¦å¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§**

## ğŸ“ˆ æ”¶ç›Š

### ç«‹å³æ”¶ç›Š
- âœ… è§£å†³å½“å‰çš„åˆ é™¤å¤±è´¥é—®é¢˜
- âœ… çŠ¶æ€å§‹ç»ˆä¿æŒä¸€è‡´
- âœ… å‡å°‘ 95% çš„ä»£ç é‡

### é•¿æœŸæ”¶ç›Š
- âœ… é›¶ç»´æŠ¤æˆæœ¬
- âœ… ä¸ä¼šäº§ç”Ÿæ–°çš„æŠ€æœ¯å€ºåŠ¡
- âœ… ç¬¦åˆ AWS æœ€ä½³å®è·µ
- âœ… æ–°æˆå‘˜å®¹æ˜“ç†è§£å’Œä½¿ç”¨

## ğŸ”§ æ•…éšœæ’é™¤

### å¦‚æœæ ˆåˆ é™¤å¤±è´¥

1. **æ£€æŸ¥çŠ¶æ€**
```bash
make check-stacks-new
```

2. **æŸ¥çœ‹å¤±è´¥åŸå› **
```bash
aws cloudformation describe-stack-events \
  --stack-name <STACK_NAME> \
  --query "StackEvents[?ResourceStatus=='DELETE_FAILED']"
```

3. **ä½¿ç”¨æ™ºèƒ½ä¿®å¤**
```bash
python3 scripts/destroy_stacks.py --force
```

4. **æœ€åæ‰‹æ®µ**ï¼ˆä»…åœ¨ç»å¯¹å¿…è¦æ—¶ï¼‰
```bash
# è·³è¿‡å¤±è´¥çš„èµ„æº
aws cloudformation delete-stack \
  --stack-name <STACK_NAME> \
  --retain-resources <RESOURCE_ID>
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [AWS CloudFormation æœ€ä½³å®è·µ](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/best-practices.html)
- [CDK RemovalPolicy](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.RemovalPolicy.html)
- [å¤„ç†æ ˆåˆ é™¤å¤±è´¥](https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-stack-delete-failed/)

## ğŸ‰ æ€»ç»“

**ç®€å•å°±æ˜¯ç»ˆæçš„å¤æ‚** - é€šè¿‡å‡å°‘ä»£ç å’Œå¤æ‚æ€§ï¼Œæˆ‘ä»¬è·å¾—äº†æ›´å¯é ã€æ›´æ˜“ç»´æŠ¤çš„è§£å†³æ–¹æ¡ˆã€‚

è¿™ä¸ªæ”¹è¿›æ–¹æ¡ˆï¼š
- **é›¶æŠ€æœ¯å€ºåŠ¡** âœ…
- **ä»£ç å‡å°‘ 95%** âœ…
- **å¯é æ€§æå‡** âœ…
- **ç»´æŠ¤æˆæœ¬æ¥è¿‘é›¶** âœ…

é€‰æ‹©é€‚åˆä½ çš„æ–¹æ¡ˆï¼Œäº«å—ç®€å•å¸¦æ¥çš„åŠ›é‡ï¼